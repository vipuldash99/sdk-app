"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __read = (this && this.__read) || function (o, n) {
    var m = typeof Symbol === "function" && o[Symbol.iterator];
    if (!m) return o;
    var i = m.call(o), r, ar = [], e;
    try {
        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);
    }
    catch (error) { e = { error: error }; }
    finally {
        try {
            if (r && !r.done && (m = i["return"])) m.call(i);
        }
        finally { if (e) throw e.error; }
    }
    return ar;
};
var __spreadArray = (this && this.__spreadArray) || function (to, from, pack) {
    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
        if (ar || !(i in from)) {
            if (!ar) ar = Array.prototype.slice.call(from, 0, i);
            ar[i] = from[i];
        }
    }
    return to.concat(ar || Array.prototype.slice.call(from));
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.UnionExplorer = void 0;
var typescript_1 = __importDefault(require("typescript"));
var ExpressionFactory_1 = require("../../factories/ExpressionFactory");
var IdentifierFactory_1 = require("../../factories/IdentifierFactory");
var check_union_array_like_1 = require("../internal/check_union_array_like");
var UnionPredicator_1 = require("./UnionPredicator");
var UnionExplorer;
(function (UnionExplorer) {
    UnionExplorer.object = function (config, level) {
        if (level === void 0) { level = 0; }
        return function (input, targets, explore, tags) {
            if (targets.length === 1)
                return config.objector.decoder(input, targets[0], explore, tags);
            var expected = "(".concat(targets
                .map(function (t) { return t.name; })
                .join(" | "), ")");
            var specList = UnionPredicator_1.UnionPredicator.object(targets);
            if (specList.length === 0) {
                var condition = config.objector.unionizer(input, targets, __assign(__assign({}, explore), { tracable: false }), tags);
                return config.objector.full
                    ? config.objector.full(condition)(input, expected, explore)
                    : condition;
            }
            var remained = targets.filter(function (t) { return specList.find(function (s) { return s.object === t; }) === undefined; });
            var conditions = specList
                .filter(function (spec) { return spec.property.key.getSoleLiteral() !== null; })
                .map(function (spec) {
                var key = spec.property.key.getSoleLiteral();
                var accessor = IdentifierFactory_1.IdentifierFactory.join(input, key);
                var pred = spec.neighbour
                    ? config.objector.checker(accessor, spec.property.value, __assign(__assign({}, explore), { tracable: false, postfix: IdentifierFactory_1.IdentifierFactory.postfix(key) }), tags)
                    : (config.objector.required || (function (exp) { return exp; }))(ExpressionFactory_1.ExpressionFactory.isRequired(accessor));
                return typescript_1.default.factory.createIfStatement((config.objector.is || (function (exp) { return exp; }))(pred), typescript_1.default.factory.createReturnStatement(config.objector.decoder(input, spec.object, explore, tags)));
            });
            return typescript_1.default.factory.createCallExpression(typescript_1.default.factory.createArrowFunction(undefined, undefined, [], undefined, undefined, typescript_1.default.factory.createBlock(__spreadArray(__spreadArray([], __read(conditions), false), [
                remained.length
                    ? typescript_1.default.factory.createReturnStatement(UnionExplorer.object(config, level + 1)(input, remained, explore, tags))
                    : config.objector.failure(input, expected, explore),
            ], false), true)), undefined, undefined);
        };
    };
    UnionExplorer.tuple = function (props) {
        return (0, check_union_array_like_1.check_union_array_like)({
            size: null,
            front: function (input) { return input; },
            array: function (input) { return input; },
            name: function (elems) { return "[".concat(elems.map(function (e) { return e.getName(); }).join(", "), "]"); },
        })(props);
    };
    UnionExplorer.array = function (props) {
        return (0, check_union_array_like_1.check_union_array_like)({
            size: function (input) { return IdentifierFactory_1.IdentifierFactory.join(input, "length"); },
            front: function (input) {
                return typescript_1.default.factory.createElementAccessExpression(input, 0);
            },
            array: function (input) { return input; },
            name: function (t) { return "Array<".concat(t.getName(), ">"); },
        })(props);
    };
    UnionExplorer.array_or_tuple = function (props) {
        return (0, check_union_array_like_1.check_union_array_like)({
            size: function (input) { return IdentifierFactory_1.IdentifierFactory.join(input, "length"); },
            front: function (input) {
                return typescript_1.default.factory.createElementAccessExpression(input, 0);
            },
            array: function (input) { return input; },
            name: function (t) {
                return Array.isArray(t)
                    ? "[".concat(t.map(function (e) { return e.getName(); }).join(", "), "]")
                    : "Array<".concat(t.getName(), ">");
            },
        })(props);
    };
    UnionExplorer.set = function (props) {
        return (0, check_union_array_like_1.check_union_array_like)({
            size: function (input) { return IdentifierFactory_1.IdentifierFactory.join(input, "size"); },
            front: function (input) {
                return IdentifierFactory_1.IdentifierFactory.join(typescript_1.default.factory.createCallExpression(IdentifierFactory_1.IdentifierFactory.join(typescript_1.default.factory.createCallExpression(IdentifierFactory_1.IdentifierFactory.join(input, "values"), undefined, undefined), "next"), undefined, undefined), "value");
            },
            array: function (input) {
                return typescript_1.default.factory.createArrayLiteralExpression([typescript_1.default.factory.createSpreadElement(input)], false);
            },
            name: function (t) { return "Set<".concat(t.getName(), ">"); },
        })(props);
    };
    UnionExplorer.map = function (props) {
        return (0, check_union_array_like_1.check_union_array_like)({
            size: function (input) { return IdentifierFactory_1.IdentifierFactory.join(input, "size"); },
            front: function (input) {
                return IdentifierFactory_1.IdentifierFactory.join(typescript_1.default.factory.createCallExpression(IdentifierFactory_1.IdentifierFactory.join(typescript_1.default.factory.createCallExpression(IdentifierFactory_1.IdentifierFactory.join(input, "entries"), undefined, undefined), "next"), undefined, undefined), "value");
            },
            array: function (input) {
                return typescript_1.default.factory.createArrayLiteralExpression([typescript_1.default.factory.createSpreadElement(input)], false);
            },
            name: function (_a) {
                var _b = __read(_a, 2), k = _b[0], v = _b[1];
                return "Map<".concat(k.getName(), ", ").concat(v.getName(), ">");
            },
        })(props);
    };
})(UnionExplorer = exports.UnionExplorer || (exports.UnionExplorer = {}));
//# sourceMappingURL=UnionExplorer.js.map